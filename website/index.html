<head>
  <title>Urop Guide</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

  <!-- Jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="data.js"></script>

  <!-- Datatables -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.css">
  <link rel="stylesheet" type="text/css" href="index.css">
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.js"></script>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

</head>

<body>
  <h1 class="title-text">UROP Listings</h1>
  <div class="content-wrapper">
    <div class="table-div">
      <table id="urop-table" class="display" style="table-layout: fixed;">
        <thead>
        	<tr>
        	  <th style="width: 10%">Date Posted</th>
        	  <th style="width: 10%">Semester</th>
        	  <th style="width: 40%">Urop Title</th>
        	  <th style="width: 20%">Urop Department</th>
        	  <th style="width: 20%">Contact</th>
        	</tr>
        </thead>
        <tfoot>
          <tr>
            <th class="select-date">
              <select>
                <option value="today">Today</option>
                <option value="week">Past Week</option>
                <option value="month">Past Month</option>
                <option value="year">Past Year</option>
                <option value="" selected>All Time</option>
              </select>
            </th>
            <th class="select-term">
              <select>
                <option value="" selected>Any</option>
                <option value="fall">Fall</option>
                <option value="iap">IAP</option>
                <option value="spring">Spring</option>
                <option value="summer">Summer</option>
              </select>
            </th>
            <th class="search-text">
              <input type="text" placeholder="Search Title" />
            </th>
            <th class="search-text">
              <input type="text" placeholder="Search Department" />
            </th>
            <th class="search-text">
              <input type="text" placeholder="Search Contact" />
            </th>
          </tr>
        </tfoot>
        <tbody id="urop-tbody">
        </tbody>
      </table>
    </div>
  </div>
</body>

<script>
  const DAY_MS = 1000 * 3600 * 24;
  const WEEK_MS = DAY_MS * 7;
  const MONTH_MS = DAY_MS * 30;
  const YEAR_MS = MONTH_MS * 12;
  var now = new Date();
  var filterType = "";

  // Convert date strings for sorting
  data.forEach(function(d) {
    var date = new Date(d.date);
    var month = date.getMonth() + 1;
    var monthStr = date.getMonth() < 10 ? `0${month}` : month;
    var day = date.getDate();
    var dayStr = day < 10 ? `0${day}` : day;
    d.sortable_date = `${date.getFullYear()}/${monthStr}/${dayStr}`
  })

  $.fn.dataTable.ext.search.push(
      function( settings, data, dataIndex ) {
        var date = new Date(data[0]);
        switch(filterType) {
          case "today":
            return now.getTime() === date.getTime();
          case "week":
            return now.getTime() - date.getTime() <= WEEK_MS;
          case "month":
            return now.getTime() - date.getTime() <= MONTH_MS;
          case "year":
            return now.getTime() - date.getTime() <= YEAR_MS;
          default:
            return true;
        }
      }
  );

  $(document).ready( function () {

    function format ( d ) {
        return d;
    }

    var table = $('#urop-table').DataTable( {
        data: data,
        "lengthChange": false,
        "bAutoWidth": false,
        "order": [[ 0, "desc" ]],
        "columnDefs": [
          {"orderData": 5, "targets": 0},
          {"visible": false, "targets": 5}
        ],
        "pageLength": 20,
        columns: [
            { data: 'date' },
            { data: 'term' },
            { data: 'project_title' },
            { data: 'department'},
            { data: 'contact' },
            { data: 'sortable_date'}
        ],
        initComplete: function() {
          this.api().columns().every(function() {
            var column = this;
            var columnType = column.footer() ? column.footer().className : "";

            switch(columnType) {
              case "select-date":
                $(column.footer())
                  .find('select')
                  .on('change', function() {
                    now = new Date();
                    filterType = this.value;
                    column.draw();
                  });
                break;

              case "select-term":
                $(column.footer())
                  .find('select')
                  .on('change', function() {
                    column
                      .search(this.value ? this.value : "", true, false)
                      .draw();
                  });
                break;

              case "search-text":
                $('input', column.footer()).on('keyup change', function() {
                  if (column.search() !== this.value) {
                    column
                      .search(this.value)
                      .draw();
                  }
                });
                break;

              default:
                break;
            }
          });
        }
    } );

    // Add event listener for opening and closing details
    $('#urop-table tbody').on('click', 'tr', function () {
        var tr = $(this).closest('tr');
        var row = table.row( tr );

        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            var description = row.data()[0];
            row.child(format(row.data()["project_desc"])).show();
            tr.addClass('shown');
        }
    } );

  } );
</script>
